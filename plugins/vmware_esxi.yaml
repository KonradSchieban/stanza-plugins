# Plugin Info
version: 0.0.4
title: VMware ESXi
description: Log parser for VMware ESXi
parameters:
  - name: listen_address
    label: Listen Address
    description: A syslog address of the form `<ip>:<port>`
    type: string
    default: "0.0.0.0:5140"

# Set Defaults
# {{$listen_address := default "0.0.0.0:5140" .listen_address}}

# Pipeline Template
pipeline:
  - id: esxi_input
    type: tcp_input
    listen_address: {{ $listen_address }}
    labels:
      log_type: vmware_esxi
      plugin_id: {{ .id }}
    output: esxi_parser

  - id: esxi_parser
    type: regex_parser
    regex: '^(?P<timestamp>[a-zA-z]+ \d{2} \d{2}:\d{2}:\d{2}) (?P<hostname>[^ ]+) (?P<service>[^ ]+) (?P<message>.*)'
    output: timestamp_router

  - id: timestamp_router
    type: router
    routes:
      - output: time_parser
        expr: '$record.timestamp matches "\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+[+-]\\d{2}:\\d{2}"'
      - output: time_parser_without_milliseconds_timezone
        expr: '$record.timestamp matches "\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z"'
      - output: {{ .output }}
        expr: 'true'

  - id: time_parser
    type: time_parser
    parse_from: $record.timestamp
    layout: '%FT%T.%s%j'
    output: {{ .output }}

  - id: time_parser_without_milliseconds_timezone
    type: time_parser
    parse_from: $record.timestamp
    layout: '%FT%TZ'
    output: {{ .output }}

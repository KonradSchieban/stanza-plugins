version: 0.0.5
title: Apache Tomcat
description: Log parser for Apache Tomcat
parameters:
  access_log_path:
    label: Access Log Path
    description: Path to access log file
    type: string
  catalina_log_path:
    label: Cataline Log Path
    description: Path to catalina log file
    type: string
  start_at:
    label: Start At
    description: Start reading file from 'beginning' or 'end'
    type: enum
    valid_values:
     - beginning
     - end
    default: end
pipeline:
  #{{ if .access_log_path }}
  - id: tomcat_access_reader
    type: file_input
    include:
      - {{ .access_log_path }}
    # {{ if .start_at }}
    start_at: {{ .start_at }}
    # {{ end }}
    labels:
      log_type: 'tomcat.access'
      plugin_id: {{ .id }}
    output: access_regex_parser

  - id: access_regex_parser
    type: regex_parser
    regex: '(?P<remote_host>[^\s]+) - (?P<remote_user>[^\s]+) \[(?P<timestamp>[^\]]+)\] "(?P<http_method>[A-Z]+) (?P<path>[^\s]+)[^"]+" (?P<http_status>\d+) (?P<bytes_sent>[^\s]+)'
    timestamp:
      parse_from: timestamp
      layout: '%d/%b/%Y:%H:%M:%S %z'
    output: {{ .output }}
  #{{ end }}

  #{{ if .catalina_log_path }}
  - id: tomcat_catalina_reader
    type: file_input
    include:
      - {{ .catalina_log_path }}
    # {{ if .start_at }}
    start_at: {{ .start_at }}
    # {{ end }}
    multiline:
      line_start_pattern: '[0-9]{2}-[A-Za-z]{3}-[0-9]{4} [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3}'
    labels:
      log_type: 'tomcat.catalina'
      plugin_id: {{ .id }}
    output: catalina_regex_parser

  - id: catalina_regex_parser
    type: regex_parser
    regex: '(?P<timestamp>[0-9]{2}-[A-Za-z]{3}-[0-9]{4} [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3})\s(?P<tomcat_severity>[A-Z]*)\s(?P<message>[\s\S]+)'
    timestamp:
      parse_from: timestamp
      layout: '%d-%b-%Y %H:%M:%S.%L'
    severity:
      parse_from: tomcat_severity
      mapping:
        notice: config
        emergency: severe
        debug:
          - fine
          - finer
          - finest
    output: {{ .output }}
  #{{ end }}
